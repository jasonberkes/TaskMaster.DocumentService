# =============================================================================
# Scheduled Deploy - DocumentService API
# =============================================================================
# Deploys DocumentService to Azure Container Apps at 2 AM CST daily
# Uses proper blue/green deployment pattern with health checks before traffic switch
# =============================================================================

name: Scheduled Deploy DocumentService

on:
  schedule:
    # Run at 2:15 AM CST (8:15 AM UTC) - offset from Platform at 2:00 AM
    - cron: '15 8 * * *'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no new image'
        type: boolean
        default: false
      traffic_percentage:
        description: 'Traffic % for new revision (blue/green)'
        type: number
        default: 100

permissions:
  contents: read
  id-token: write

env:
  AZURE_RESOURCE_GROUP: 'tm-rg-prod-eus2'
  AZURE_ACR_NAME: 'tmcrprodeus2'
  IMAGE_NAME: 'documentservice-api'
  CONTAINER_APP_NAME: 'tm-documentservice-prod-eus2'
  APP_URL: 'https://tm-documentservice-prod-eus2.thankfulsand-8986c25c.eastus2.azurecontainerapps.io'
  API_BASE_URL: 'https://taskmaster-platform.thankfulsand-8986c25c.eastus2.azurecontainerapps.io'

jobs:
  check-for-updates:
    name: Check for New Image
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      current_tag: ${{ steps.check.outputs.current_tag }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check for New Image
        id: check
        run: |
          echo "üîç Checking for new images in ACR..."
          
          # Get latest tag from ACR
          LATEST_TAG=$(az acr repository show-tags \
            --name ${{ env.AZURE_ACR_NAME }} \
            --repository ${{ env.IMAGE_NAME }} \
            --orderby time_desc \
            --top 1 \
            --output tsv 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "‚ùå No images found in ACR for ${{ env.IMAGE_NAME }}"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest ACR tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Check if container app exists
          APP_EXISTS=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$APP_EXISTS" ]; then
            echo "üì¶ Container app doesn't exist - will deploy"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "current_tag=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get current deployed image tag from the revision with traffic
          CURRENT_REVISION=$(az containerapp ingress traffic show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?weight > 0].revisionName | [0]" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$CURRENT_REVISION" ]; then
            CURRENT_IMAGE=$(az containerapp revision show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "$CURRENT_REVISION" \
              --query "properties.template.containers[0].image" -o tsv 2>/dev/null || echo "")
            CURRENT_TAG=$(echo "$CURRENT_IMAGE" | sed 's/.*://')
          else
            CURRENT_TAG="unknown"
          fi
          
          echo "Currently deployed: $CURRENT_TAG"
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          
          # Compare tags
          if [ "$LATEST_TAG" = "$CURRENT_TAG" ]; then
            if [ "${{ inputs.force_deploy }}" = "true" ]; then
              echo "‚úÖ Force deploy requested"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Already running latest version"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "üöÄ New version available!"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Blue/Green Deploy
    needs: check-for-updates
    if: needs.check-for-updates.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.APP_URL }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy New Revision
        id: deploy
        run: |
          set -e
          
          IMAGE="${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.check-for-updates.outputs.latest_tag }}"
          REVISION_SUFFIX="deploy-$(date +%Y%m%d%H%M%S)"
          TRAFFIC_WEIGHT="${{ inputs.traffic_percentage || 100 }}"
          
          echo "=========================================="
          echo "Deploying DocumentService"
          echo "Image: $IMAGE"
          echo "Revision: $REVISION_SUFFIX"
          echo "Traffic: $TRAFFIC_WEIGHT%"
          echo "=========================================="
          
          # Get current revision with traffic (for potential rollback)
          OLD_REVISION=$(az containerapp ingress traffic show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?weight > 0].revisionName | [0]" -o tsv 2>/dev/null || echo "")
          
          echo "old_revision=$OLD_REVISION" >> $GITHUB_OUTPUT
          echo "Current revision: $OLD_REVISION"
          
          # Check if app exists
          APP_EXISTS=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$APP_EXISTS" ]; then
            echo "üì¶ Creating new Container App via Bicep..."
            
            az deployment group create \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --template-file infrastructure/bicep/container-app.bicep \
              --parameters \
                environment=prod \
                containerImage="$IMAGE" \
                revisionSuffix="$REVISION_SUFFIX" \
                newRevisionTrafficWeight=0 \
                minReplicas=1 \
                maxReplicas=5
          else
            echo "üîÑ Deploying new revision..."
            
            # Deploy new revision (traffic stays on old revision)
            az containerapp update \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --image "$IMAGE" \
              --revision-suffix "$REVISION_SUFFIX"
          fi
          
          # Wait for revision to be created
          sleep 15
          
          # Get the NEW revision by sorting by creation time (newest first)
          NEW_REVISION=$(az containerapp revision list \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "sort_by(@, &properties.createdTime) | reverse(@) | [0].name" -o tsv)
          
          echo "new_revision=$NEW_REVISION" >> $GITHUB_OUTPUT
          echo "New revision: $NEW_REVISION"
          
          # Wait for revision to be ready
          echo "‚è≥ Waiting for revision to be ready..."
          MAX_WAIT=120
          WAITED=0
          while [ $WAITED -lt $MAX_WAIT ]; do
            HEALTH=$(az containerapp revision show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "$NEW_REVISION" \
              --query "properties.healthState" -o tsv 2>/dev/null || echo "Unknown")
            
            RUNNING=$(az containerapp revision show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "$NEW_REVISION" \
              --query "properties.runningState" -o tsv 2>/dev/null || echo "Unknown")
            
            echo "  Health: $HEALTH, Running: $RUNNING"
            
            if [ "$HEALTH" = "Healthy" ] && [ "$RUNNING" = "Running" ]; then
              echo "‚úÖ Revision is healthy and running!"
              break
            fi
            
            if [ "$HEALTH" = "Unhealthy" ] || [ "$RUNNING" = "Failed" ]; then
              echo "‚ùå Revision failed to start!"
              echo "revision_healthy=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            sleep 10
            WAITED=$((WAITED + 10))
          done
          
          if [ $WAITED -ge $MAX_WAIT ]; then
            echo "‚ùå Timeout waiting for revision to be ready"
            echo "revision_healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "revision_healthy=true" >> $GITHUB_OUTPUT

      - name: Health Check
        if: steps.deploy.outputs.revision_healthy == 'true'
        id: health
        run: |
          echo "üè• Running health check on new revision..."
          
          MAX_ATTEMPTS=10
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              "${{ env.APP_URL }}/health" \
              --max-time 10 || echo "000")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed!"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: HTTP $HTTP_CODE"
            sleep 5
          done
          
          echo "‚ùå Health check failed after $MAX_ATTEMPTS attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Switch Traffic
        if: steps.health.outputs.healthy == 'true'
        run: |
          TRAFFIC_WEIGHT="${{ inputs.traffic_percentage || 100 }}"
          NEW_REVISION="${{ steps.deploy.outputs.new_revision }}"
          OLD_REVISION="${{ steps.deploy.outputs.old_revision }}"
          
          echo "üîÄ Switching traffic to new revision..."
          
          if [ "$TRAFFIC_WEIGHT" = "100" ]; then
            az containerapp ingress traffic set \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision-weight "$NEW_REVISION=100"
            echo "‚úÖ 100% traffic now on $NEW_REVISION"
          else
            OLD_WEIGHT=$((100 - TRAFFIC_WEIGHT))
            az containerapp ingress traffic set \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision-weight "$NEW_REVISION=$TRAFFIC_WEIGHT" "$OLD_REVISION=$OLD_WEIGHT"
            echo "‚úÖ Traffic split: $NEW_REVISION=$TRAFFIC_WEIGHT%, $OLD_REVISION=$OLD_WEIGHT%"
          fi

      - name: Cleanup Old Revisions
        if: always()
        run: |
          echo "üßπ Cleaning up old revisions (keeping 3 most recent)..."
          
          # Get all revisions sorted by creation time, skip the 3 newest
          OLD_REVISIONS=$(az containerapp revision list \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "sort_by(@, &properties.createdTime) | reverse(@) | [3:].name" -o tsv)
          
          if [ -z "$OLD_REVISIONS" ]; then
            echo "No old revisions to clean up"
            exit 0
          fi
          
          for REV in $OLD_REVISIONS; do
            echo "Deactivating: $REV"
            az containerapp revision deactivate \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "$REV" 2>/dev/null || true
          done
          
          echo "‚úÖ Cleanup complete"

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ${{ env.AZURE_ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ needs.check-for-updates.outputs.latest_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Revision | ${{ steps.deploy.outputs.new_revision }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Old Revision | ${{ steps.deploy.outputs.old_revision }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Traffic | ${{ inputs.traffic_percentage || 100 }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Revision Healthy | ${{ steps.deploy.outputs.revision_healthy }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ steps.health.outputs.healthy || 'failed' }} |" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    needs: [check-for-updates, deploy]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Report Failure
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the workflow logs for details."
          # TODO: Add Slack/email notification here

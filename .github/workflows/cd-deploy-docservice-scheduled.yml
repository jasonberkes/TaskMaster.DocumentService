# =============================================================================
# Scheduled Deploy - DocumentService API
# =============================================================================
# Daily deployment at 2:15 AM CST using blue-green strategy
# Uses shared deployment script for consistency with Platform
# =============================================================================

name: Scheduled Deploy DocumentService

on:
  schedule:
    - cron: '15 8 * * *'  # 2:15 AM CST (8:15 AM UTC)
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy even if no new image'
        type: boolean
        default: false
      gradual_rollout:
        description: 'Use gradual rollout (10% ‚Üí 50% ‚Üí 100%)'
        type: boolean
        default: false
      traffic_percentage:
        description: 'Traffic % for new revision'
        type: number
        default: 100

permissions:
  contents: read
  id-token: write

env:
  AZURE_RESOURCE_GROUP: 'tm-rg-prod-eus2'
  AZURE_ACR_NAME: 'tmcrprodeus2'
  IMAGE_NAME: 'documentservice-api'
  CONTAINER_APP_NAME: 'tm-documentservice-prod-eus2'
  APP_URL: 'https://tm-documentservice-prod-eus2.thankfulsand-8986c25c.eastus2.azurecontainerapps.io'
  PLATFORM_API_URL: 'https://taskmaster-platform.thankfulsand-8986c25c.eastus2.azurecontainerapps.io'

jobs:
  check-for-updates:
    name: Check for New Image
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      latest_tag: ${{ steps.check.outputs.latest_tag }}
      current_tag: ${{ steps.check.outputs.current_tag }}
    
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check for New Image
        id: check
        run: |
          echo "üîç Checking for new images..."
          
          LATEST_TAG=$(az acr repository show-tags \
            --name ${{ env.AZURE_ACR_NAME }} \
            --repository ${{ env.IMAGE_NAME }} \
            --orderby time_desc --top 1 -o tsv 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "‚ùå No images found"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Get current deployed tag from revision with traffic
          CURRENT_REVISION=$(az containerapp ingress traffic show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?weight > 0].revisionName | [0]" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$CURRENT_REVISION" ]; then
            CURRENT_IMAGE=$(az containerapp revision show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --revision "$CURRENT_REVISION" \
              --query "properties.template.containers[0].image" -o tsv 2>/dev/null || echo "")
            CURRENT_TAG=$(echo "$CURRENT_IMAGE" | sed 's/.*://')
          else
            CURRENT_TAG="none"
          fi
          
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "Latest: $LATEST_TAG, Current: $CURRENT_TAG"
          
          if [ "$LATEST_TAG" = "$CURRENT_TAG" ]; then
            if [ "${{ inputs.force_deploy }}" = "true" ]; then
              echo "‚úÖ Force deploy requested"
              echo "should_deploy=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Already running latest"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "üöÄ New version available!"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Blue/Green Deploy
    needs: check-for-updates
    if: needs.check-for-updates.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ env.APP_URL }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy
        id: deploy
        env:
          PLATFORM_API_KEY: ${{ secrets.TASKMASTER_API_KEY }}
        run: |
          chmod +x ./scripts/deploy-bluegreen.sh
          
          ARGS="${{ needs.check-for-updates.outputs.latest_tag }}"
          
          if [ "${{ inputs.gradual_rollout }}" = "true" ]; then
            ARGS="$ARGS --gradual"
          fi
          
          if [ "${{ inputs.traffic_percentage }}" != "100" ] && [ -n "${{ inputs.traffic_percentage }}" ]; then
            ARGS="$ARGS --traffic ${{ inputs.traffic_percentage }}"
          fi
          
          ./scripts/deploy-bluegreen.sh $ARGS

      - name: Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.check-for-updates.outputs.latest_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Tag | ${{ needs.check-for-updates.outputs.current_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gradual Rollout | ${{ inputs.gradual_rollout || false }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.deploy.outcome }} |" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    needs: [check-for-updates, deploy]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Report Failure
        run: |
          echo "‚ùå Deployment failed - check workflow logs"
